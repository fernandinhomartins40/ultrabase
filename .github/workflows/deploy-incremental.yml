name: ğŸš€ Deploy Incremental Inteligente

# Controle de concorrÃªncia
concurrency:
  group: ultrabase-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'supabase-core/**'
      - 'package*.json'
      - '.github/workflows/deploy-incremental.yml'
  workflow_dispatch:

env:
  VPS_HOST: '82.25.69.57'
  VPS_USER: 'root'
  DEPLOY_DIR: '/opt/supabase-manager'

jobs:
  analyze-changes:
    name: ğŸ” Analisar MudanÃ§as
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
      has_package_changes: ${{ steps.changes.outputs.has_package_changes }}
      has_config_changes: ${{ steps.changes.outputs.has_config_changes }}
      needs_restart: ${{ steps.changes.outputs.needs_restart }}
      deploy_type: ${{ steps.changes.outputs.deploy_type }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: ğŸ” Analisar arquivos alterados
      id: changes
      run: |
        echo "ğŸ” Analisando mudanÃ§as desde o Ãºltimo commit..."
        
        # Obter arquivos alterados
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "all")
        echo "ğŸ“ Arquivos alterados:"
        echo "$CHANGED_FILES"
        
        # Inicializar flags
        HAS_CODE=false
        HAS_PACKAGE=false
        HAS_CONFIG=false
        NEEDS_RESTART=false
        
        # Analisar tipos de mudanÃ§as
        if echo "$CHANGED_FILES" | grep -E "(src/.*\.(js|ts|json|html|css)|supabase-core/|src/public/)" > /dev/null; then
          HAS_CODE=true
          echo "âœ… MudanÃ§as de cÃ³digo detectadas"
          
          # Mostrar detalhes das mudanÃ§as especÃ­ficas
          if echo "$CHANGED_FILES" | grep -E "\.html$" > /dev/null; then
            echo "ğŸ¨ Arquivos HTML alterados - interface serÃ¡ atualizada"
          fi
          if echo "$CHANGED_FILES" | grep -E "src/public/" > /dev/null; then
            echo "ğŸ“ Arquivos pÃºblicos alterados - assets serÃ£o atualizados"
          fi
        fi
        
        if echo "$CHANGED_FILES" | grep -E "package(-lock)?\.json" > /dev/null; then
          HAS_PACKAGE=true
          echo "ğŸ“¦ MudanÃ§as em dependÃªncias detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "(docker|config|\.env)" > /dev/null; then
          HAS_CONFIG=true
          echo "âš™ï¸ MudanÃ§as de configuraÃ§Ã£o detectadas"
        fi
        
        # Determinar se precisa restart
        if [[ "$HAS_CODE" == "true" || "$HAS_CONFIG" == "true" ]]; then
          NEEDS_RESTART=true
        fi
        
        # Determinar tipo de deploy
        if [[ "$HAS_PACKAGE" == "true" ]]; then
          DEPLOY_TYPE="full"
          echo "ğŸ”„ Deploy completo necessÃ¡rio (dependÃªncias mudaram)"
        elif [[ "$HAS_CODE" == "true" ]]; then
          DEPLOY_TYPE="code-only"
          echo "ğŸ“ Deploy apenas de cÃ³digo"
        elif [[ "$HAS_CONFIG" == "true" ]]; then
          DEPLOY_TYPE="config-only"
          echo "âš™ï¸ Deploy apenas de configuraÃ§Ã£o"
        else
          DEPLOY_TYPE="minimal"
          echo "ğŸ“‹ Deploy mÃ­nimo (docs/workflows)"
        fi
        
        # Definir outputs
        echo "has_code_changes=$HAS_CODE" >> $GITHUB_OUTPUT
        echo "has_package_changes=$HAS_PACKAGE" >> $GITHUB_OUTPUT
        echo "has_config_changes=$HAS_CONFIG" >> $GITHUB_OUTPUT
        echo "needs_restart=$NEEDS_RESTART" >> $GITHUB_OUTPUT
        echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT

  deploy:
    name: ğŸš€ Deploy Incremental
    runs-on: ubuntu-latest
    needs: analyze-changes
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“‹ Info do Deploy Incremental
      run: |
        echo "ğŸš€ Deploy Incremental Inteligente - Ultrabase"
        echo "=============================================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "MudanÃ§as de CÃ³digo: ${{ needs.analyze-changes.outputs.has_code_changes }}"
        echo "MudanÃ§as de DependÃªncias: ${{ needs.analyze-changes.outputs.has_package_changes }}"
        echo "Precisa Restart: ${{ needs.analyze-changes.outputs.needs_restart }}"
        echo "=============================================="

    - name: ğŸ”‘ Configurar SSH
      run: |
        echo "ğŸ”‘ Configurando SSH para deploy incremental..."
        sudo apt-get update && sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
        echo "âœ… SSH configurado"

    - name: ğŸ” Verificar estado atual da VPS
      run: |
        echo "ğŸ” Verificando estado atual..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== Estado Atual da VPS ==='
          echo 'AplicaÃ§Ã£o PM2:'
          pm2 list | grep supabase-manager || echo 'NÃ£o rodando'
          
          echo ''
          echo 'InstÃ¢ncias preservadas:'
          if [ -f ${{ env.DEPLOY_DIR }}/src/instances.json ]; then
            INSTANCES=\$(cat ${{ env.DEPLOY_DIR }}/src/instances.json | jq '.instances | length' 2>/dev/null || echo '0')
            echo \"ğŸ“Š \$INSTANCES instÃ¢ncias ativas\"
          else
            echo 'ğŸ“‹ Nenhuma instÃ¢ncia (arquivo nÃ£o existe)'
          fi
          
          echo ''
          echo 'Ãšltima atualizaÃ§Ã£o:'
          cd ${{ env.DEPLOY_DIR }} && git log --oneline -1 2>/dev/null || echo 'RepositÃ³rio nÃ£o inicializado'
        "

    - name: ğŸ“¦ Backup Inteligente (somente se necessÃ¡rio)
      if: needs.analyze-changes.outputs.deploy_type == 'full'
      run: |
        echo "ğŸ“¦ Fazendo backup completo (deploy full)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR=/opt/supabase-manager-backups/backup_\$TIMESTAMP
          mkdir -p \$BACKUP_DIR
          
          # Backup crÃ­tico sempre
          if [ -f ${{ env.DEPLOY_DIR }}/src/instances.json ]; then
            cp ${{ env.DEPLOY_DIR }}/src/instances.json \$BACKUP_DIR/
            echo 'âœ… instances.json backed up'
          fi
          
          echo \"ğŸ“¦ Backup completo criado: \$BACKUP_DIR\"
        "

    - name: ğŸ“¦ Backup RÃ¡pido (somente dados crÃ­ticos)
      if: needs.analyze-changes.outputs.deploy_type != 'full'
      run: |
        echo "ğŸ“¦ Backup rÃ¡pido (apenas instances.json)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          if [ -f ${{ env.DEPLOY_DIR }}/src/instances.json ]; then
            cp ${{ env.DEPLOY_DIR }}/src/instances.json /tmp/instances_backup.json
            echo 'âœ… instances.json preservado'
          fi
        "

    - name: ğŸ”„ AtualizaÃ§Ã£o Incremental do CÃ³digo
      run: |
        echo "ğŸ”„ Atualizando cÃ³digo via git pull incremental..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          # Verificar se repositÃ³rio existe
          if [ ! -d .git ]; then
            echo 'ğŸ†• Primeira vez: clonando repositÃ³rio...'
            git clone https://github.com/fernandinhomartins40/ultrabase.git .
          else
            echo 'ğŸ“¥ Fazendo pull incremental das mudanÃ§as...'
            
            # Salvar status atual
            git stash push -m 'Auto-stash before deploy' 2>/dev/null || true
            
            # Pull incremental
            git fetch origin
            BEFORE=\$(git rev-parse HEAD)
            git pull origin main
            AFTER=\$(git rev-parse HEAD)
            
            if [ \"\$BEFORE\" != \"\$AFTER\" ]; then
              echo \"âœ… CÃ³digo atualizado: \$BEFORE -> \$AFTER\"
            else
              echo 'ğŸ“‹ CÃ³digo jÃ¡ atualizado'
            fi
          fi
        "

    - name: ğŸ”„ Restaurar Dados Preservados
      run: |
        echo "ğŸ”„ Garantindo preservaÃ§Ã£o dos dados..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          # Restaurar instances.json se foi perdido no git pull
          if [ ! -f src/instances.json ] && [ -f /tmp/instances_backup.json ]; then
            mkdir -p src
            cp /tmp/instances_backup.json src/instances.json
            echo 'âœ… instances.json restaurado do backup rÃ¡pido'
          elif [ -f src/instances.json ]; then
            echo 'âœ… instances.json jÃ¡ presente'
          fi
          
          # Verificar se backup completo existe e restaurar se necessÃ¡rio
          LATEST_BACKUP=\$(ls -t /opt/supabase-manager-backups/backup_* 2>/dev/null | head -1 || echo '')
          if [ ! -f src/instances.json ] && [ -n \"\$LATEST_BACKUP\" ] && [ -f \"\$LATEST_BACKUP/instances.json\" ]; then
            mkdir -p src
            cp \"\$LATEST_BACKUP/instances.json\" src/instances.json
            echo 'âœ… instances.json restaurado do backup completo'
          fi
          
          echo 'ğŸ›¡ï¸ Dados crÃ­ticos preservados'
        "

    - name: ğŸ“¦ Instalar DependÃªncias (somente se necessÃ¡rio)
      if: needs.analyze-changes.outputs.has_package_changes == 'true'
      run: |
        echo "ğŸ“¦ Instalando dependÃªncias (package.json mudou)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}/src
          npm install --production --silent
          echo 'âœ… DependÃªncias atualizadas'
        "

    - name: ğŸ“¦ Skip DependÃªncias (nÃ£o necessÃ¡rio)
      if: needs.analyze-changes.outputs.has_package_changes == 'false'
      run: |
        echo "ğŸ“¦ Pulando instalaÃ§Ã£o de dependÃªncias (package.json nÃ£o mudou)"
        echo "âš¡ Deploy mais rÃ¡pido!"

    - name: ğŸ”„ Restart Inteligente da AplicaÃ§Ã£o
      if: needs.analyze-changes.outputs.needs_restart == 'true'
      run: |
        echo "ğŸ”„ Reiniciando aplicaÃ§Ã£o (cÃ³digo/config mudou)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}/src
          
          # Tentar reload primeiro (mais rÃ¡pido)
          if pm2 list | grep -q supabase-manager; then
            echo 'ğŸ”„ Fazendo reload (preserva conexÃµes)...'
            pm2 reload supabase-manager
          else
            echo 'ğŸš€ Iniciando aplicaÃ§Ã£o...'
            pm2 start server.js --name supabase-manager
          fi
          
          pm2 save
          echo 'âœ… AplicaÃ§Ã£o atualizada'
        "

    - name: ğŸ“‹ Skip Restart (nÃ£o necessÃ¡rio)
      if: needs.analyze-changes.outputs.needs_restart == 'false'
      run: |
        echo "ğŸ“‹ Restart nÃ£o necessÃ¡rio (apenas docs/workflows mudaram)"
        echo "âš¡ AplicaÃ§Ã£o continua rodando sem interrupÃ§Ã£o!"

    - name: â³ Aguardar EstabilizaÃ§Ã£o
      if: needs.analyze-changes.outputs.needs_restart == 'true'
      run: |
        echo "â³ Aguardando aplicaÃ§Ã£o estabilizar apÃ³s restart..."
        sleep 10

    - name: ğŸ” VerificaÃ§Ã£o RÃ¡pida
      run: |
        echo "ğŸ” VerificaÃ§Ã£o final..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Verificar PM2
          if pm2 list | grep -q supabase-manager; then
            echo 'âœ… PM2 rodando'
          else
            echo 'âŒ PM2 nÃ£o encontrado'
            exit 1
          fi
          
          # Verificar health check rÃ¡pido
          for i in {1..3}; do
            if curl -f -s http://localhost:3080/api/health >/dev/null 2>&1; then
              echo 'âœ… Health check OK'
              break
            else
              echo \"â³ Tentativa \$i/3...\"
              sleep 5
            fi
            
            if [ \$i -eq 3 ]; then
              echo 'âš ï¸ Health check demorou, mas PM2 estÃ¡ rodando'
            fi
          done
        "

    - name: ğŸ“Š RelatÃ³rio do Deploy Incremental
      if: always()
      run: |
        echo "ğŸ“Š RELATÃ“RIO DO DEPLOY INCREMENTAL"
        echo "=================================="
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo 'Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}'
          echo 'Restart Executado: ${{ needs.analyze-changes.outputs.needs_restart }}'
          echo 'DependÃªncias Atualizadas: ${{ needs.analyze-changes.outputs.has_package_changes }}'
          echo ''
          
          echo '=== Status da AplicaÃ§Ã£o ==='
          pm2 list --no-colors | grep -E 'name|supabase-manager' || echo 'PM2 nÃ£o encontrado'
          
          echo ''
          echo '=== InstÃ¢ncias Preservadas ==='
          if [ -f ${{ env.DEPLOY_DIR }}/src/instances.json ]; then
            INSTANCES=\$(cat ${{ env.DEPLOY_DIR }}/src/instances.json | jq '.instances | length' 2>/dev/null || echo '0')
            echo \"ğŸ“Š \$INSTANCES instÃ¢ncias preservadas\"
          else
            echo 'Nenhuma instÃ¢ncia encontrada'
          fi
          
          echo ''
          echo '=== Ãšltimo Commit ==='
          cd ${{ env.DEPLOY_DIR }} && git log --oneline -1
          
          echo ''
          echo 'ğŸ¯ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}/'
          echo 'âš¡ Deploy incremental concluÃ­do!'
        "

    - name: ğŸ‰ Deploy Incremental ConcluÃ­do
      run: |
        echo "ğŸ‰ DEPLOY INCREMENTAL REALIZADO COM SUCESSO!"
        echo "âš¡ Tipo: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "ğŸ›¡ï¸ Dados preservados: SIM"
        echo "ğŸš€ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}/" 