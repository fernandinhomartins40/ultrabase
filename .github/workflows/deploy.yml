name: Deploy Supabase Instance Manager to VPS Hostinger

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '82.25.69.57'
  VPS_USER: 'root'
  APP_DIR: '/opt/supabase-manager'
  MANAGER_PORT: '3080'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.VPS_HOST }}
        username: ${{ env.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 900s
        command_timeout: 900s
        script: |
          # FunÃ§Ã£o de log
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }
          
          # ====================================
          # ETAPA 1: PREPARAR AMBIENTE
          # ====================================
          log "ğŸš€ INICIANDO DEPLOY SUPABASE INSTANCE MANAGER - ETAPA 1: Preparando ambiente..."
          
          # ConfiguraÃ§Ãµes
          APP_DIR="${{ env.APP_DIR }}"
          REPO_URL="https://github.com/fernandinhomartins40/ultrabase.git"
          
          # Parar instÃ¢ncias existentes ANTES de qualquer operaÃ§Ã£o
          log "â¹ï¸ Parando gerenciador e instÃ¢ncias existentes..."
          
          # Parar gerenciador na porta 3080
          PID=$(lsof -t -i:3080 2>/dev/null) || true
          if [ ! -z "$PID" ]; then
            kill -9 $PID
            log "âœ… Gerenciador parado (PID: $PID)"
          fi
          
          # Parar todas as instÃ¢ncias Supabase ativas
          if [ -d "$APP_DIR/supabase-core" ]; then
            cd $APP_DIR/supabase-core
            for compose_file in docker-compose-*.yml; do
              if [ -f "$compose_file" ]; then
                log "â¹ï¸ Parando instÃ¢ncia: $(basename "$compose_file")"
                docker compose -f "$compose_file" down --remove-orphans || true
              fi
            done
          fi
          
          # Criar diretÃ³rio principal
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          # ====================================
          # ETAPA 2: BAIXAR/ATUALIZAR CÃ“DIGO
          # ====================================
          log "ğŸš€ ETAPA 2: Baixando cÃ³digo do Supabase Instance Manager..."
          
          # Se nÃ£o existe repositÃ³rio, clonar
          if [ ! -d ".git" ]; then
            log "ğŸ“¥ Clonando repositÃ³rio Ultrabase..."
            git clone $REPO_URL . || {
              log "âŒ Clone falhou, usando download direto..."
              curl -L https://github.com/fernandinhomartins40/ultrabase/archive/main.tar.gz | tar xz --strip-components=1
            }
          else
            # Atualizar repositÃ³rio existente
            log "ğŸ”„ Atualizando repositÃ³rio..."
            git fetch origin && git reset --hard origin/main && git clean -fd
          fi
          
          # Verificar se estrutura foi baixada corretamente
          if [ ! -d "src" ]; then
            log "âŒ DiretÃ³rio src nÃ£o encontrado!"
            exit 1
          fi
          
          if [ ! -d "supabase-core" ]; then
            log "âŒ DiretÃ³rio supabase-core nÃ£o encontrado!"
            exit 1
          fi
          
          if [ ! -f "src/server.js" ]; then
            log "âŒ Arquivo server.js nÃ£o encontrado!"
            exit 1
          fi
          
          log "âœ… CÃ³digo baixado com sucesso"
          
          # ====================================
          # ETAPA 3: INSTALAR DEPENDÃŠNCIAS
          # ====================================
          log "ğŸš€ ETAPA 3: Verificando/instalando dependÃªncias..."
          
          # Atualizar sistema
          apt-get update -qq
          
          # Instalar Docker se necessÃ¡rio
          if ! command -v docker >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Docker..."
            curl -fsSL https://get.docker.com | sh
            systemctl start docker
            systemctl enable docker
          else
            log "âœ… Docker jÃ¡ instalado: $(docker --version)"
          fi
          
          # Verificar Docker Compose
          if ! docker compose version >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Docker Compose..."
            apt-get install -y docker-compose-plugin
          else
            log "âœ… Docker Compose jÃ¡ instalado: $(docker compose version)"
          fi
          
          # Instalar Node.js se necessÃ¡rio
          if ! command -v node >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
          else
            NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
            if [ "$NODE_VERSION" -lt 18 ]; then
              log "ğŸ“¦ Atualizando Node.js para versÃ£o 18+..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
              apt-get install -y nodejs
            else
              log "âœ… Node.js jÃ¡ instalado: $(node --version)"
            fi
          fi
          
          # Instalar PM2 para gerenciamento de processos
          if ! command -v pm2 >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando PM2..."
            npm install -g pm2
          else
            log "âœ… PM2 jÃ¡ instalado: $(pm2 --version)"
          fi
          
          # ====================================
          # ETAPA 4: CONFIGURAR APLICAÃ‡ÃƒO
          # ====================================
          log "ğŸš€ ETAPA 4: Configurando aplicaÃ§Ã£o..."
          
          # Navegar para diretÃ³rio do gerenciador
          cd $APP_DIR/src
          
          # Instalar dependÃªncias NPM
          log "ğŸ“¦ Instalando dependÃªncias NPM..."
          npm install --production --silent
          
          # Criar arquivo de configuraÃ§Ã£o de produÃ§Ã£o
          log "âš™ï¸ Criando configuraÃ§Ãµes de produÃ§Ã£o..."
          
          # Configurar variÃ¡veis de ambiente
          cat > .env << EOF
          NODE_ENV=production
          MANAGER_PORT=${{ env.MANAGER_PORT }}
          VPS_HOST=${{ env.VPS_HOST }}
          MAX_INSTANCES=20
          DOCKER_DIR=../supabase-core
          EOF
          
          # Criar diretÃ³rios necessÃ¡rios
          mkdir -p logs
          
          # Inicializar arquivo de instÃ¢ncias se nÃ£o existir
          if [ ! -f "instances.json" ] || [ ! -s "instances.json" ]; then
            echo "{}" > instances.json
            log "âœ… Arquivo instances.json inicializado"
          fi
          
          # Configurar permissÃµes
          chmod +x install.sh || true
          chmod +x start.sh || true
          chmod +x stop.sh || true
          
          # ====================================
          # ETAPA 5: CONFIGURAR FIREWALL
          # ====================================
          log "ğŸš€ ETAPA 5: Configurando firewall..."
          
          # Configurar UFW se disponÃ­vel
          if command -v ufw >/dev/null 2>&1; then
            # Permitir portas do gerenciador
            ufw allow ${{ env.MANAGER_PORT }}/tcp || true
            
            # Permitir faixa de portas para instÃ¢ncias
            ufw allow 8100:8199/tcp || true  # Kong HTTP
            ufw allow 8400:8499/tcp || true  # Kong HTTPS
            ufw allow 5500:5599/tcp || true  # PostgreSQL
            ufw allow 4100:4199/tcp || true  # Analytics
            
            log "âœ… Firewall configurado"
          else
            log "âš ï¸ UFW nÃ£o disponÃ­vel, configure firewall manualmente"
          fi
          
          # ====================================
          # ETAPA 6: INICIAR APLICAÃ‡ÃƒO
          # ====================================
          log "ğŸš€ ETAPA 6: Iniciando Supabase Instance Manager..."
          
          # Parar instÃ¢ncia PM2 anterior se existir
          pm2 delete supabase-manager 2>/dev/null || true
          
          # Criar arquivo ecosystem.config.js para PM2
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'supabase-manager',
              script: 'server.js',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '1G',
              env: {
                NODE_ENV: 'production',
                PORT: process.env.MANAGER_PORT || 3080
              },
              error_file: './logs/err.log',
              out_file: './logs/out.log',
              log_file: './logs/combined.log',
              time: true
            }]
          }
          EOF
          
          # Iniciar aplicaÃ§Ã£o com PM2
          pm2 start ecosystem.config.js
          pm2 save
          pm2 startup || true
          
          log "âœ… AplicaÃ§Ã£o iniciada com PM2"
          
          # ====================================
          # ETAPA 7: VERIFICAÃ‡Ã•ES DE SAÃšDE
          # ====================================
          log "ğŸš€ ETAPA 7: Verificando deployment..."
          
          # Aguardar aplicaÃ§Ã£o inicializar
          log "â³ Aguardando aplicaÃ§Ã£o inicializar..."
          sleep 15
          
          # Verificar se aplicaÃ§Ã£o estÃ¡ rodando
          if pm2 list | grep -q "supabase-manager.*online"; then
            log "âœ… AplicaÃ§Ã£o PM2 estÃ¡ online"
          else
            log "âŒ AplicaÃ§Ã£o PM2 nÃ£o estÃ¡ online"
            pm2 logs supabase-manager --lines 20
            exit 1
          fi
          
          # Verificar se porta estÃ¡ ativa
          if lsof -Pi :${{ env.MANAGER_PORT }} -sTCP:LISTEN -t >/dev/null; then
            log "âœ… Porta ${{ env.MANAGER_PORT }} estÃ¡ ativa"
          else
            log "âŒ Porta ${{ env.MANAGER_PORT }} nÃ£o estÃ¡ ativa"
            exit 1
          fi
          
          # Health check HTTP
          HEALTH_CHECK_ATTEMPTS=0
          MAX_ATTEMPTS=10
          
          while [ $HEALTH_CHECK_ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            if curl -f -s http://localhost:${{ env.MANAGER_PORT }}/api/health >/dev/null 2>&1; then
              log "âœ… Health check HTTP: OK"
              break
            else
              HEALTH_CHECK_ATTEMPTS=$((HEALTH_CHECK_ATTEMPTS + 1))
              log "â³ Tentativa $HEALTH_CHECK_ATTEMPTS/$MAX_ATTEMPTS - Aguardando health check..."
              sleep 5
            fi
          done
          
          if [ $HEALTH_CHECK_ATTEMPTS -eq $MAX_ATTEMPTS ]; then
            log "âŒ Health check falhou apÃ³s $MAX_ATTEMPTS tentativas"
            pm2 logs supabase-manager --lines 20
            exit 1
          fi
          
          # Verificar se consegue listar instÃ¢ncias
          if curl -f -s http://localhost:${{ env.MANAGER_PORT }}/api/instances >/dev/null 2>&1; then
            log "âœ… API de instÃ¢ncias: OK"
          else
            log "âŒ API de instÃ¢ncias: FALHOU"
            exit 1
          fi
          
          # ====================================
          # ETAPA 8: CONFIGURAR NGINX (OPCIONAL)
          # ====================================
          log "ğŸš€ ETAPA 8: Configurando proxy reverso..."
          
          # Instalar Nginx se nÃ£o existir
          if ! command -v nginx >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Nginx..."
            apt-get install -y nginx
          fi
          
          # Criar configuraÃ§Ã£o Nginx
          cat > /etc/nginx/sites-available/supabase-manager << EOF
          server {
              listen 80;
              server_name ${{ env.VPS_HOST }};
              
              # Dashboard principal
              location / {
                  proxy_pass http://localhost:${{ env.MANAGER_PORT }};
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
                  proxy_read_timeout 300s;
                  proxy_connect_timeout 300s;
              }
              
              # Proxy para instÃ¢ncias Supabase (portas 8100-8199)
              location ~ ^/instance-(\d+)/(.*) {
                  set \$instance_port 8\$1;
                  proxy_pass http://localhost:\$instance_port/\$2\$is_args\$args;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
                  proxy_read_timeout 300s;
                  proxy_connect_timeout 300s;
              }
          }
          EOF
          
          # Ativar configuraÃ§Ã£o
          ln -sf /etc/nginx/sites-available/supabase-manager /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          
          # Testar e recarregar Nginx
          if nginx -t 2>/dev/null; then
            systemctl reload nginx
            log "âœ… Nginx configurado e recarregado"
          else
            log "âŒ Erro na configuraÃ§Ã£o Nginx"
            nginx -t
          fi
          
          # ====================================
          # ETAPA 9: RESULTADO FINAL
          # ====================================
          log "ğŸš€ ETAPA 9: Finalizando deployment..."
          
          # Mostrar status final
          log "ğŸ“‹ Status dos serviÃ§os:"
          log "   - PM2: $(pm2 list | grep supabase-manager | awk '{print $10}')"
          log "   - Nginx: $(systemctl is-active nginx)"
          log "   - Docker: $(systemctl is-active docker)"
          
          # Mostrar instÃ¢ncias ativas
          ACTIVE_INSTANCES=$(ls $APP_DIR/supabase-core/docker-compose-*.yml 2>/dev/null | wc -l)
          log "   - InstÃ¢ncias Supabase: $ACTIVE_INSTANCES"
          
          # Mostrar logs recentes
          log "ğŸ“‹ Logs recentes da aplicaÃ§Ã£o:"
          pm2 logs supabase-manager --lines 10 --nostream
          
          log "ğŸ‰ DEPLOY DO SUPABASE INSTANCE MANAGER CONCLUÃDO COM SUCESSO!"
          log ""
          log "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em:"
          log "   - Dashboard Principal: http://${{ env.VPS_HOST }} (Interface de Gerenciamento)"
          log "   - API Direta: http://${{ env.VPS_HOST }}:${{ env.MANAGER_PORT }}"
          log "   - Health Check: http://${{ env.VPS_HOST }}/api/health"
          log ""
          log "ğŸ® Como usar:"
          log "   1. Acesse: http://${{ env.VPS_HOST }}"
          log "   2. Clique em 'Criar Novo Projeto'"
          log "   3. Informe o nome do projeto"
          log "   4. Aguarde a criaÃ§Ã£o (30-60 segundos)"
          log "   5. Acesse o Studio via link fornecido"
          log ""
          log "ğŸ“Š Recursos disponÃ­veis:"
          log "   - MÃ¡ximo de instÃ¢ncias: 20"
          log "   - Portas Kong: 8100-8199"
          log "   - Portas PostgreSQL: 5500-5599"
          log "   - Portas Analytics: 4100-4199"
          log ""
          log "ğŸ”§ Comandos Ãºteis:"
          log "   - Ver logs: pm2 logs supabase-manager"
          log "   - Restart: pm2 restart supabase-manager"
          log "   - Status: pm2 status"
          log ""
          log "ğŸ¯ Seu Supabase Cloud privado estÃ¡ funcionando!"