name: ğŸš€ Deploy Ultrabase Simplificado

# Controle de concorrÃªncia
concurrency:
  group: ultrabase-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'supabase-core/**'
      - 'package*.json'
      - '.github/workflows/deploy-simple.yml'
  workflow_dispatch:

env:
  VPS_HOST: '82.25.69.57'
  VPS_USER: 'root'
  DEPLOY_DIR: '/opt/supabase-manager'

jobs:
  deploy:
    name: ğŸš€ Deploy Direto
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“‹ Info do Deploy
      run: |
        echo "ğŸš€ Deploy Ultrabase - MÃ©todo Simplificado"
        echo "========================================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "========================================="

    - name: ğŸ”‘ Configurar SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ” Verificar conexÃ£o SSH
      run: |
        echo "ğŸ” Testando conexÃ£o SSH..."
        ssh -o ConnectTimeout=10 ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK - $(date)'"

    - name: ğŸ“¦ Backup rÃ¡pido (instances.json)
      run: |
        echo "ğŸ“¦ Fazendo backup dos dados crÃ­ticos..."
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Criar backup timestamp
          TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          mkdir -p /opt/supabase-manager-backups/backup_\$TIMESTAMP
          
          # Backup apenas dos dados crÃ­ticos
          if [ -f ${{ env.DEPLOY_DIR }}/src/instances.json ]; then
            cp ${{ env.DEPLOY_DIR }}/src/instances.json /opt/supabase-manager-backups/backup_\$TIMESTAMP/
            echo 'âœ… instances.json backed up'
          fi
          
          if [ -d ${{ env.DEPLOY_DIR }}/src/logs ]; then
            cp -r ${{ env.DEPLOY_DIR }}/src/logs /opt/supabase-manager-backups/backup_\$TIMESTAMP/
            echo 'âœ… logs backed up'
          fi
          
          echo \"ğŸ“¦ Backup criado: backup_\$TIMESTAMP\"
        "

    - name: ğŸ”„ Atualizar cÃ³digo (git pull)
      run: |
        echo "ğŸ”„ Atualizando cÃ³digo via git pull..."
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          # Verificar se Ã© um repositÃ³rio git
          if [ ! -d .git ]; then
            echo 'ğŸ†• Clonando repositÃ³rio...'
            git clone https://github.com/fernandinhomartins40/ultrabase.git .
          else
            echo 'ğŸ“¥ Fazendo git pull...'
            git fetch origin
            git pull origin main
          fi
          
          echo 'âœ… CÃ³digo atualizado'
        "

    - name: ğŸ”„ Restaurar dados preservados
      run: |
        echo "ğŸ”„ Restaurando dados preservados..."
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          # Encontrar backup mais recente
          LATEST_BACKUP=\$(ls -t /opt/supabase-manager-backups/backup_* 2>/dev/null | head -1 || echo '')
          
          if [ -n \"\$LATEST_BACKUP\" ] && [ -d \"\$LATEST_BACKUP\" ]; then
            echo \"ğŸ”„ Restaurando do backup: \$LATEST_BACKUP\"
            
            # Restaurar instances.json
            if [ -f \"\$LATEST_BACKUP/instances.json\" ]; then
              mkdir -p src
              cp \"\$LATEST_BACKUP/instances.json\" src/instances.json
              echo 'âœ… instances.json restaurado'
            fi
            
            # Restaurar logs
            if [ -d \"\$LATEST_BACKUP/logs\" ]; then
              mkdir -p src
              cp -r \"\$LATEST_BACKUP/logs\" src/
              echo 'âœ… logs restaurados'
            fi
          else
            echo 'â„¹ï¸ Nenhum backup encontrado, continuando...'
          fi
        "

    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        echo "ğŸ“¦ Instalando dependÃªncias NPM..."
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}/src
          npm install --production --silent
          echo 'âœ… DependÃªncias instaladas'
        "

    - name: ğŸš€ Reiniciar aplicaÃ§Ã£o
      run: |
        echo "ğŸš€ Reiniciando aplicaÃ§Ã£o com PM2..."
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}/src
          
          # Parar aplicaÃ§Ã£o existente
          pm2 stop supabase-manager 2>/dev/null || true
          pm2 delete supabase-manager 2>/dev/null || true
          
          # Iniciar aplicaÃ§Ã£o
          pm2 start server.js --name supabase-manager
          pm2 save
          
          echo 'âœ… AplicaÃ§Ã£o reiniciada'
        "

    - name: â³ Aguardar estabilizaÃ§Ã£o
      run: |
        echo "â³ Aguardando aplicaÃ§Ã£o estabilizar..."
        sleep 15

    - name: ğŸ” Verificar aplicaÃ§Ã£o
      run: |
        echo "ğŸ” Verificando se aplicaÃ§Ã£o estÃ¡ funcionando..."
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Verificar PM2
          if pm2 list | grep -q supabase-manager; then
            echo 'âœ… PM2 rodando'
          else
            echo 'âŒ PM2 nÃ£o encontrado'
            exit 1
          fi
          
          # Aguardar um pouco mais
          sleep 10
          
          # Verificar health check (com retry)
          for i in {1..6}; do
            if curl -f -s http://localhost:3080/api/health >/dev/null 2>&1; then
              echo 'âœ… Health check OK'
              break
            else
              echo \"â³ Tentativa \$i/6 - aguardando...\"
              sleep 10
            fi
            
            if [ \$i -eq 6 ]; then
              echo 'âŒ Health check falhou apÃ³s 6 tentativas'
              exit 1
            fi
          done
        "

    - name: ğŸ“Š Status final
      if: always()
      run: |
        echo "ğŸ“Š Status final do deploy:"
        ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== PM2 Status ==='
          pm2 list --no-colors | grep -E 'name|supabase-manager' || echo 'PM2 nÃ£o encontrado'
          
          echo ''
          echo '=== Health Check ==='
          curl -s http://localhost:3080/api/health | jq '.status, .version, .uptime' 2>/dev/null || echo 'API nÃ£o responde'
          
          echo ''
          echo '=== InstÃ¢ncias Preservadas ==='
          if [ -f ${{ env.DEPLOY_DIR }}/src/instances.json ]; then
            cat ${{ env.DEPLOY_DIR }}/src/instances.json | jq '.instances | length' 2>/dev/null || echo 'Erro ao ler instances.json'
          else
            echo 'Nenhuma instÃ¢ncia encontrada'
          fi
          
          echo ''
          echo 'ğŸ¯ URLs disponÃ­veis:'
          echo '  - Dashboard: http://${{ env.VPS_HOST }}/'
          echo '  - API: http://${{ env.VPS_HOST }}:3080/'
          echo '  - Health: http://${{ env.VPS_HOST }}:3080/api/health'
        "

    - name: ğŸ‰ Deploy concluÃ­do
      run: |
        echo "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
        echo "âœ… AplicaÃ§Ã£o estÃ¡ online em: http://${{ env.VPS_HOST }}/" 