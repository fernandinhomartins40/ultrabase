#!/bin/bash

# üöÄ Supabase Instance Manager - Instalador Autom√°tico
# 
# Este script configura automaticamente o Gerenciador de Inst√¢ncias Supabase
# Replica a experi√™ncia do Supabase Cloud em sua pr√≥pria VPS

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Fun√ß√£o para printar com cores
print_color() {
    printf "${1}${2}${NC}\n"
}

print_header() {
    echo ""
    print_color $CYAN "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    print_color $CYAN "‚ïë                                                              ‚ïë"
    print_color $CYAN "‚ïë         üöÄ SUPABASE INSTANCE MANAGER INSTALLER             ‚ïë"
    print_color $CYAN "‚ïë                                                              ‚ïë"
    print_color $CYAN "‚ïë         Seu Supabase Cloud Privado                          ‚ïë"
    print_color $CYAN "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
}

print_step() {
    print_color $BLUE "üî∑ $1"
}

print_success() {
    print_color $GREEN "‚úÖ $1"
}

print_warning() {
    print_color $YELLOW "‚ö†Ô∏è  $1"
}

print_error() {
    print_color $RED "‚ùå $1"
}

# Verificar se est√° sendo executado como root
check_root() {
    if [[ $EUID -eq 0 ]]; then
        print_warning "Este script n√£o deve ser executado como root"
        print_color $YELLOW "Execute como usu√°rio normal: ./install.sh"
        exit 1
    fi
}

# Verificar se Docker est√° instalado e funcionando
check_docker() {
    print_step "Verificando Docker..."
    
    if ! command -v docker &> /dev/null; then
        print_error "Docker n√£o est√° instalado"
        print_color $YELLOW "Instale o Docker primeiro: https://docs.docker.com/get-docker/"
        exit 1
    fi
    
    if ! docker version &> /dev/null; then
        print_error "Docker n√£o est√° funcionando"
        print_color $YELLOW "Verifique se o Docker est√° rodando: sudo systemctl start docker"
        exit 1
    fi
    
    if ! docker compose version &> /dev/null; then
        print_error "Docker Compose n√£o est√° instalado"
        print_color $YELLOW "Instale o Docker Compose: https://docs.docker.com/compose/install/"
        exit 1
    fi
    
    print_success "Docker e Docker Compose OK"
}

# Verificar se Node.js est√° instalado
check_nodejs() {
    print_step "Verificando Node.js..."
    
    if ! command -v node &> /dev/null; then
        print_error "Node.js n√£o est√° instalado"
        print_color $YELLOW "Instale Node.js 18+: https://nodejs.org/"
        exit 1
    fi
    
    NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
    if [ "$NODE_VERSION" -lt 18 ]; then
        print_error "Node.js vers√£o 18+ √© necess√°ria (atual: $(node --version))"
        print_color $YELLOW "Atualize para Node.js 18+: https://nodejs.org/"
        exit 1
    fi
    
    if ! command -v npm &> /dev/null; then
        print_error "NPM n√£o est√° instalado"
        exit 1
    fi
    
    print_success "Node.js $(node --version) e NPM OK"
}

# Verificar estrutura do Supabase
check_supabase_structure() {
    print_step "Verificando estrutura do Supabase..."
    
    DOCKER_DIR="../docker"
    
    if [ ! -d "$DOCKER_DIR" ]; then
        print_error "Diret√≥rio $DOCKER_DIR n√£o encontrado"
        print_color $YELLOW "Execute este script dentro do diret√≥rio supabase-manager/"
        print_color $YELLOW "A estrutura deve ser:"
        print_color $YELLOW "  ultrabase/"
        print_color $YELLOW "  ‚îú‚îÄ‚îÄ docker/"
        print_color $YELLOW "  ‚îî‚îÄ‚îÄ supabase-manager/"
        exit 1
    fi
    
    if [ ! -f "$DOCKER_DIR/docker-compose.yml" ]; then
        print_error "Arquivo docker-compose.yml n√£o encontrado em $DOCKER_DIR"
        exit 1
    fi
    
    if [ ! -f "$DOCKER_DIR/.env.template" ]; then
        print_error "Arquivo .env.template n√£o encontrado em $DOCKER_DIR"
        exit 1
    fi
    
    if [ ! -d "$DOCKER_DIR/volumes" ]; then
        print_error "Diret√≥rio volumes n√£o encontrado em $DOCKER_DIR"
        exit 1
    fi
    
    print_success "Estrutura do Supabase OK"
}

# Verificar porta dispon√≠vel
check_port() {
    print_step "Verificando porta 3080..."
    
    if lsof -Pi :3080 -sTCP:LISTEN -t >/dev/null; then
        print_warning "Porta 3080 est√° em uso"
        print_color $YELLOW "Parando processo na porta 3080..."
        
        PID=$(lsof -t -i:3080)
        if [ ! -z "$PID" ]; then
            kill -9 $PID 2>/dev/null || true
            sleep 2
        fi
        
        if lsof -Pi :3080 -sTCP:LISTEN -t >/dev/null; then
            print_error "N√£o foi poss√≠vel liberar a porta 3080"
            print_color $YELLOW "Libere a porta manualmente e tente novamente"
            exit 1
        fi
    fi
    
    print_success "Porta 3080 dispon√≠vel"
}

# Instalar depend√™ncias NPM
install_dependencies() {
    print_step "Instalando depend√™ncias NPM..."
    
    if [ ! -f "package.json" ]; then
        print_error "Arquivo package.json n√£o encontrado"
        print_color $YELLOW "Execute este script dentro do diret√≥rio supabase-manager/"
        exit 1
    fi
    
    npm install --silent
    
    print_success "Depend√™ncias instaladas"
}

# Criar diret√≥rios necess√°rios
create_directories() {
    print_step "Criando diret√≥rios necess√°rios..."
    
    mkdir -p logs
    touch instances.json
    
    # Criar arquivo de configura√ß√£o padr√£o se n√£o existir
    if [ ! -f "instances.json" ] || [ ! -s "instances.json" ]; then
        echo "{}" > instances.json
    fi
    
    print_success "Diret√≥rios criados"
}

# Verificar permiss√µes Docker
check_docker_permissions() {
    print_step "Verificando permiss√µes Docker..."
    
    if ! docker ps &> /dev/null; then
        print_warning "Usu√°rio n√£o tem permiss√µes para usar Docker"
        print_color $YELLOW "Adicionando usu√°rio ao grupo docker..."
        
        # Tentar adicionar ao grupo docker
        if command -v usermod &> /dev/null; then
            sudo usermod -aG docker $USER
            print_color $YELLOW "Usu√°rio adicionado ao grupo docker"
            print_color $YELLOW "REINICIE o terminal ou execute: newgrp docker"
            print_color $YELLOW "Depois execute o instalador novamente"
            exit 0
        else
            print_error "N√£o foi poss√≠vel adicionar usu√°rio ao grupo docker"
            print_color $YELLOW "Execute manualmente: sudo usermod -aG docker $USER"
            print_color $YELLOW "Depois reinicie o terminal"
            exit 1
        fi
    fi
    
    print_success "Permiss√µes Docker OK"
}

# Testar cria√ß√£o de inst√¢ncia
test_system() {
    print_step "Testando sistema..."
    
    # Iniciar servidor em background
    print_color $CYAN "Iniciando servidor de teste..."
    node server.js &
    SERVER_PID=$!
    
    # Aguardar servidor inicializar
    sleep 5
    
    # Testar endpoint de health
    if curl -s http://localhost:3080/api/health > /dev/null; then
        print_success "Servidor funcionando corretamente"
    else
        print_error "Servidor n√£o est√° respondendo"
        kill $SERVER_PID 2>/dev/null || true
        exit 1
    fi
    
    # Parar servidor de teste
    kill $SERVER_PID 2>/dev/null || true
    sleep 2
    
    print_success "Teste conclu√≠do"
}

# Criar script de inicializa√ß√£o
create_startup_script() {
    print_step "Criando script de inicializa√ß√£o..."
    
    cat > start.sh << 'EOF'
#!/bin/bash

# üöÄ Supabase Instance Manager - Start Script

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "üöÄ Iniciando Supabase Instance Manager..."

# Verificar se j√° est√° rodando
if lsof -Pi :3080 -sTCP:LISTEN -t >/dev/null; then
    echo "‚ö†Ô∏è  Gerenciador j√° est√° rodando na porta 3080"
    echo "   Acesse: http://localhost:3080"
    exit 0
fi

# Verificar Docker
if ! docker version &> /dev/null; then
    echo "‚ùå Docker n√£o est√° funcionando"
    echo "   Inicie o Docker: sudo systemctl start docker"
    exit 1
fi

# Iniciar servidor
echo "üî∑ Iniciando servidor..."
node server.js

EOF

    chmod +x start.sh
    
    print_success "Script de inicializa√ß√£o criado (start.sh)"
}

# Criar script de parada
create_stop_script() {
    print_step "Criando script de parada..."
    
    cat > stop.sh << 'EOF'
#!/bin/bash

# üõë Supabase Instance Manager - Stop Script

echo "üõë Parando Supabase Instance Manager..."

# Parar servidor na porta 3080
PID=$(lsof -t -i:3080 2>/dev/null)
if [ ! -z "$PID" ]; then
    kill -9 $PID
    echo "‚úÖ Servidor parado"
else
    echo "‚ÑπÔ∏è  Servidor n√£o estava rodando"
fi

# Opcional: Parar todas as inst√¢ncias Supabase
read -p "Parar todas as inst√¢ncias Supabase? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üî∑ Parando todas as inst√¢ncias Supabase..."
    
    # Encontrar todos os docker-compose de inst√¢ncias
    for compose_file in ../docker/docker-compose-*.yml; do
        if [ -f "$compose_file" ]; then
            echo "  Parando: $(basename "$compose_file")"
            cd ../docker
            docker compose -f "$(basename "$compose_file")" down 2>/dev/null || true
            cd - > /dev/null
        fi
    done
    
    echo "‚úÖ Todas as inst√¢ncias foram paradas"
fi

echo "üèÅ Processo conclu√≠do"

EOF

    chmod +x stop.sh
    
    print_success "Script de parada criado (stop.sh)"
}

# Fun√ß√£o principal
main() {
    print_header
    
    print_color $PURPLE "Configurando seu Supabase Cloud privado..."
    echo ""
    
    # Verifica√ß√µes
    check_root
    check_docker
    check_nodejs
    check_supabase_structure
    check_docker_permissions
    check_port
    
    # Instala√ß√£o
    install_dependencies
    create_directories
    create_startup_script
    create_stop_script
    
    # Teste
    test_system
    
    # Sucesso
    echo ""
    print_color $GREEN "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    print_color $GREEN "‚ïë                                                              ‚ïë"
    print_color $GREEN "‚ïë         üéâ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!               ‚ïë"
    print_color $GREEN "‚ïë                                                              ‚ïë"
    print_color $GREEN "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    
    print_success "Supabase Instance Manager instalado com sucesso!"
    echo ""
    
    print_color $CYAN "üìã PR√ìXIMOS PASSOS:"
    echo ""
    print_color $YELLOW "1. Iniciar o gerenciador:"
    print_color $WHITE "   ./start.sh"
    echo ""
    print_color $YELLOW "2. Acessar dashboard:"
    print_color $WHITE "   http://localhost:3080"
    echo ""
    print_color $YELLOW "3. Criar seu primeiro projeto:"
    print_color $WHITE "   Click em 'Criar Novo Projeto'"
    echo ""
    print_color $YELLOW "4. Para parar o sistema:"
    print_color $WHITE "   ./stop.sh"
    echo ""
    
    print_color $CYAN "üéØ FUNCIONALIDADES DISPON√çVEIS:"
    echo "   ‚úÖ Dashboard web igual ao supabase.com"
    echo "   ‚úÖ Cria√ß√£o de projetos isolados"
    echo "   ‚úÖ URLs √∫nicas para cada projeto"
    echo "   ‚úÖ Gerenciamento completo via web"
    echo "   ‚úÖ Monitoramento em tempo real"
    echo "   ‚úÖ Logs individuais por projeto"
    echo ""
    
    print_color $GREEN "Seu Supabase Cloud privado est√° pronto! üöÄ"
    echo ""
    
    # Perguntar se deve iniciar automaticamente
    read -p "Deseja iniciar o gerenciador agora? (Y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        print_color $CYAN "Execute ./start.sh quando estiver pronto!"
    else
        print_color $CYAN "Iniciando gerenciador..."
        ./start.sh
    fi
}

# Executar fun√ß√£o principal
main "$@"